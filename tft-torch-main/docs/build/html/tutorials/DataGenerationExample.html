

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Favorita Dataset Creation Example &mdash; tft-torch 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "document", "processHtmlClass": "math|output_area"}}</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Model Training" href="TrainingExample.html" />
    <link rel="prev" title="Tutorials" href="../tutorials.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> tft-torch
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">tft-torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Favorita Dataset Creation Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Data-related-notes">Data-related notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Importing-the-required-libraries">Importing the required libraries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Configuration-details">Configuration details</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Attributes-configuration">Attributes configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Data-Loading">Data Loading</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Filter,-Maniplate-&amp;-Resample">Filter, Maniplate &amp; Resample</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Filter">Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Manipulate">Manipulate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Temporal-resampling-of-each-combination-(1-days-interval)">Temporal resampling of each combination (1 days interval)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Gathering-Information">Gathering Information</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Merging-with-other-sources">Merging with other sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Inferring-Composition">Inferring Composition</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Data-Scaling">Data Scaling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Fitting-the-scalers/encoders">Fitting the scalers/encoders</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Transform-by-Applying-Scalers">Transform by Applying Scalers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Splitting-Data">Splitting Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Export-processed-data">Export processed data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="TrainingExample.html">Model Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="TrainingExample.html#Explore-Model-Outputs">Explore Model Outputs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">tft-torch Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../help.html">Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tft-torch</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../tutorials.html">Tutorials</a> &raquo;</li>
        
      <li>Favorita Dataset Creation Example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorials/DataGenerationExample.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Favorita-Dataset-Creation-Example">
<h1>Favorita Dataset Creation Example<a class="headerlink" href="#Favorita-Dataset-Creation-Example" title="Permalink to this headline">¶</a></h1>
<p>This tutorial demonstrates the creation of a dataset in a format that can be fed to the <code class="docutils literal notranslate"><span class="pre">TemporalFusionTransformer</span></code>. It does not demonstrate direct usage of the implementation suggested in this package, but merely suggesting a methodology for generating a suitable dataset.</p>
<div class="section" id="Data-related-notes">
<h2>Data-related notes<a class="headerlink" href="#Data-related-notes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The dataset used for this demonstration is the <a class="reference external" href="https://www.kaggle.com/c/favorita-grocery-sales-forecasting/overview">Corporación Favorita Grocery Sales Forecasting</a> dataset, hosted on <a class="reference external" href="https://www.kaggle.com/">Kaggle</a>. One can use <a class="reference external" href="https://github.com/Kaggle/kaggle-api">Kaggle API</a> in order to download the dataset.</p></li>
<li><p>The set of relevant CSV files are download as one compressed zip archive. Unarchiving the zip file will generate a set of <strong>.7z</strong> compressed files, which require unarchiving as well - ending with the set CSV files required for this demonstration.</p></li>
<li><p>The following procedure was inspired by the one implemented on <a class="reference external" href="https://github.com/google-research/google-research">google-research repository</a>, which can be found <a class="reference external" href="https://github.com/google-research/google-research/tree/master/tft">here</a>.</p></li>
</ul>
<ins><p><strong>Note</strong>:</p>
</ins><p>the presented implementation might not be the most efficient way for achieving the processed dataset, and the steps demonstrated below are elaborated for clarity. Moreover, the time boundaries settings can be adapted and modified for using a shorter period of time, as processing the entire dataset might take some time.</p>
</div>
<div class="section" id="Importing-the-required-libraries">
<h2>Importing the required libraries<a class="headerlink" href="#Importing-the-required-libraries" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pandas.api.types</span> <span class="k">as</span> <span class="nn">ptypes</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">QuantileTransformer</span><span class="p">,</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">MinMaxScaler</span>
</pre></div>
</div>
</div>
<div class="section" id="Configuration-details">
<h3>Configuration details<a class="headerlink" href="#Configuration-details" title="Permalink to this headline">¶</a></h3>
<p>Set the path to the directory containing the CSV files, as well as the output path, where the processed dataset will be stored:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.../data/favorita/raw&#39;</span><span class="p">)</span>
<span class="c1"># set parent directory as the output path</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Set the time boundaries according to which the data will be generated:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># No records will be considered outside these bounds</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Where training period ends and the validation period begins</span>
<span class="n">validation_bound</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We also need to set what is the historical scope, in terms of temporal steps, to conisder for each observation, as well as the maximal horizon (in time-steps) for which the prediction will be required, for each observation. In our case, each observation corresponds to a time-series, and the time-steps correspond to days.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">history_len</span> <span class="o">=</span> <span class="mi">90</span>  <span class="c1"># historical scope in time-steps</span>
<span class="n">future_len</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># futuristic scope in time-steps</span>
</pre></div>
</div>
</div>
<p>One more temporal configuration argument we need to set is the sampling interval; In order ease the processing of the dataset, we generate a new shiny time-series, spaced with <code class="docutils literal notranslate"><span class="pre">samp_interval</span></code> steps from the adjacent time-series (imposing some overlap between adjacent observations).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">samp_interval</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># time-steps</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Attributes-configuration">
<h2>Attributes configuration<a class="headerlink" href="#Attributes-configuration" title="Permalink to this headline">¶</a></h2>
<p>For the multi-horizon forecasting scenario, we consider three primary channels of information flowing into the model as input data: * past/historical temporal information, which is the observed time-series. * static information, in the form of non-temporal attributes associated with the observation. * futuristic temporal information, which is known in advance, for each of the horizons we are about the predict.</p>
<p>Each of this channels can be composed of numeric variables, and from categorical variables. In the following sections, one can find the specification of each attribute’s assignment:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># These are the variables that are known in advance, and will compose the futuristic time-series</span>
<span class="n">known_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;onpromotion&#39;</span><span class="p">,</span>
               <span class="s1">&#39;day_of_week&#39;</span><span class="p">,</span>
               <span class="s1">&#39;day_of_month&#39;</span><span class="p">,</span>
               <span class="s1">&#39;month&#39;</span><span class="p">,</span>
               <span class="s1">&#39;national_holiday&#39;</span><span class="p">,</span>
               <span class="s1">&#39;regional_holiday&#39;</span><span class="p">,</span>
               <span class="s1">&#39;local_holiday&#39;</span><span class="p">,</span>
               <span class="s1">&#39;open&#39;</span>
               <span class="p">]</span>

<span class="c1"># The following set of variables will be considered as static, i.e. containing non-temporal information</span>
<span class="c1"># every attribute which is not listed here will be considered as temporal.</span>
<span class="n">static_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;item_nbr&#39;</span><span class="p">,</span>
                <span class="s1">&#39;store_nbr&#39;</span><span class="p">,</span>
                <span class="s1">&#39;city&#39;</span><span class="p">,</span>
                <span class="s1">&#39;state&#39;</span><span class="p">,</span>
                <span class="s1">&#39;store_type&#39;</span><span class="p">,</span>
                <span class="s1">&#39;store_cluster&#39;</span><span class="p">,</span>
                <span class="s1">&#39;item_family&#39;</span><span class="p">,</span>
                <span class="s1">&#39;item_class&#39;</span><span class="p">,</span>
                <span class="s1">&#39;perishable&#39;</span><span class="p">,</span>
                <span class="p">]</span>

<span class="c1"># The following set of variables will be considered as categorical.</span>
<span class="c1"># The rest of the variables (which are not listed below) will be considered as numeric.</span>
<span class="n">categorical_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;item_nbr&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;store_nbr&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;city&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;state&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;store_type&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;store_cluster&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;item_family&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;item_class&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;perishable&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;onpromotion&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;open&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;day_of_week&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;month&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;national_holiday&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;regional_holiday&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;local_holiday&#39;</span><span class="p">,</span>
                     <span class="p">]</span>
</pre></div>
</div>
</div>
<p>We also need to specify which of the attributes represents the signal we would like to predict into the future:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">target_signal</span> <span class="o">=</span> <span class="s1">&#39;log_sales&#39;</span>
</pre></div>
</div>
</div>
<p>and a list of variables which are not to be considered as actual features - these can be the time index associated with each record, the ID associated with the observation, or features that are already represented by some other variable:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># these will not be included as part of the input data which will end up feeding the model</span>
<span class="n">meta_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;combination_id&#39;</span><span class="p">,</span> <span class="s1">&#39;temporal_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unit_sales&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="Data-Loading">
<h3>Data Loading<a class="headerlink" href="#Data-Loading" title="Permalink to this headline">¶</a></h3>
<p>Listing the relevant files:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;*.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">)))]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">file_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Load the CSV files:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">transactions_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;transactions.csv&#39;</span><span class="p">),</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                              <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">items_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;items.csv&#39;</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;item_nbr&#39;</span><span class="p">)</span>
<span class="n">oil_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;oil.csv&#39;</span><span class="p">),</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
<span class="n">holiday_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;holidays_events.csv&#39;</span><span class="p">),</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                         <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;transferred&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">})</span>
<span class="n">stores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;stores.csv&#39;</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;store_nbr&#39;</span><span class="p">)</span>

<span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;train.csv&#39;</span><span class="p">),</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;onpromotion&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">},</span>
                      <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
                      <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># we will not use the test data in this demonstration -</span>
<span class="c1"># the entire dataset will be created using the &#39;train.csv&#39; file.</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;test.csv&#39;</span><span class="p">),</span>
                      <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
                      <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>and fix nulls on the <code class="docutils literal notranslate"><span class="pre">onpromotion</span></code> indicator, transforming this attribute to <code class="docutils literal notranslate"><span class="pre">bool</span></code> type.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="n">ptypes</span><span class="o">.</span><span class="n">is_object_dtype</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;onpromotion&#39;</span><span class="p">]):</span>
    <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;onpromotion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;onpromotion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span>
</pre></div>
</div>
</div>
<p>Some of the columns are renamed for better clarity when the information will be gathered from the various sources:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">stores_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;store_type&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">:</span> <span class="s1">&#39;store_cluster&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">items_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;item_class&#39;</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;item_family&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">oil_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dcoilwtico&#39;</span><span class="p">:</span> <span class="s1">&#39;oil_price&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">holiday_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;holiday_type&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>And the oil price is interpolated (<code class="docutils literal notranslate"><span class="pre">method='ffill'</span></code>) before we associate it with the other temporal records.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Lose the null records on the raw dataframe representing oil prices</span>
<span class="n">oil_df</span> <span class="o">=</span> <span class="n">oil_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">oil_df</span><span class="o">.</span><span class="n">oil_price</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
<span class="n">oil_df</span> <span class="o">=</span> <span class="n">oil_df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Filter,-Maniplate-&amp;-Resample">
<h3>Filter, Maniplate &amp; Resample<a class="headerlink" href="#Filter,-Maniplate-&-Resample" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="Filter">
<h2>Filter<a class="headerlink" href="#Filter" title="Permalink to this headline">¶</a></h2>
<p>Before merging and joining the other sources of data into the <code class="docutils literal notranslate"><span class="pre">data_df</span></code>, which represents the primary source of data associated with each observation, we restrict it and filter in order to keep only the records within the boundaries we set above.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Manipulate">
<h2>Manipulate<a class="headerlink" href="#Manipulate" title="Permalink to this headline">¶</a></h2>
<p>In the dataset we’re dealing with, each time-series is associated with two primary entities: * the selling store * the sold product</p>
<p>Hence, the following snippet will generate an ID, <code class="docutils literal notranslate"><span class="pre">combination_id</span></code>, which will identify the combination of a specific store and a specific product.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">combination_id</span><span class="o">=</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;store_nbr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;item_nbr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
<span class="c1"># another index can be used to identify the unique combination of (store,product,date)</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">temporal_id</span><span class="o">=</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;combination_id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>In addition, we discard (store,item) combinations with negative sales observed:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># for each combination, we calculate the minimal unit_sales value</span>
<span class="n">min_sales</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;combination_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;unit_sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="c1"># keep only combination with non-negative sales.</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;combination_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">min_sales</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_sales</span><span class="o">.</span><span class="n">unit_sales</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;combination_id&#39;</span><span class="p">])]</span>
</pre></div>
</div>
</div>
<p>And mark all the existing records as days in which the relevant stores were open:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># mark all the existing records as days in which the relevant stores were open</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="nb">open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Temporal-resampling-of-each-combination-(1-days-interval)">
<h2>Temporal resampling of each combination (1 days interval)<a class="headerlink" href="#Temporal-resampling-of-each-combination-(1-days-interval)" title="Permalink to this headline">¶</a></h2>
<p>We are generating a dense sequence of records for each combination by resamplings, so that for each step in the time-window covered by this sequence, there will be a corresponding records. The records generated by this resampling procedure, will be considered as days where the specific store was closed (<code class="docutils literal notranslate"><span class="pre">open=False</span></code>). <strong>Note</strong>: As part of the resampling, we also assign a new column to contain <code class="docutils literal notranslate"><span class="pre">log_sales</span></code> which will be our target signal.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sequence_per_combination</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># a list to contain all the resampled sequences</span>

<span class="c1"># for each combination</span>
<span class="k">for</span> <span class="n">comb_id</span><span class="p">,</span> <span class="n">comb_df</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;combination_id&#39;</span><span class="p">)):</span>
    <span class="n">resamp_seq</span> <span class="o">=</span> <span class="n">comb_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">resamp_seq</span> <span class="o">=</span> <span class="n">resamp_seq</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">resamp_seq</span><span class="p">[</span><span class="s1">&#39;log_sales&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">resamp_seq</span><span class="p">[</span><span class="s1">&#39;unit_sales&#39;</span><span class="p">])</span>
    <span class="c1"># newly generated records are assumed to be days in which the store was not open</span>
    <span class="n">resamp_seq</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resamp_seq</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># pad with the corresponding information according to the previously available record</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;store_nbr&#39;</span><span class="p">,</span> <span class="s1">&#39;item_nbr&#39;</span><span class="p">,</span> <span class="s1">&#39;onpromotion&#39;</span><span class="p">]:</span>
        <span class="n">resamp_seq</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">resamp_seq</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>

    <span class="n">sequence_per_combination</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resamp_seq</span><span class="p">)</span>

<span class="c1"># combine all the resampled sequences</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sequence_per_combination</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Gathering-Information">
<h3>Gathering Information<a class="headerlink" href="#Gathering-Information" title="Permalink to this headline">¶</a></h3>
<p>Before merging the other sources, we can add some time-related information using the specified date associated with each record:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">dayofweek</span>
<span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;day_of_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">day</span>
<span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">month</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Merging-with-other-sources">
<h2>Merging with other sources<a class="headerlink" href="#Merging-with-other-sources" title="Permalink to this headline">¶</a></h2>
<p>Adding the metadata associated with each store and item:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">stores_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;store_nbr&#39;</span><span class="p">)</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">items_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;item_nbr&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Adding the holiday-related information associated with each date:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># we&#39;ll ignore holidays that were &quot;transferred&quot;</span>
<span class="n">holiday_df</span> <span class="o">=</span> <span class="n">holiday_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">holiday_df</span><span class="o">.</span><span class="n">transferred</span><span class="p">]</span>

<span class="c1"># National holidays will mark every relevant record (by date)</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">national_holiday</span><span class="o">=</span><span class="n">data_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">holiday_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">holiday_df</span><span class="o">.</span><span class="n">locale</span> <span class="o">==</span> <span class="s1">&#39;National&#39;</span><span class="p">],</span>
                                                        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
                         <span class="p">)</span>

<span class="c1"># Regional holidays will mark every relevant record (by date and state)</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">regional_holiday</span><span class="o">=</span><span class="n">data_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">holiday_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">holiday_df</span><span class="o">.</span><span class="n">locale</span> <span class="o">==</span> <span class="s1">&#39;Regional&#39;</span><span class="p">],</span>
                                                        <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">],</span>
                                                        <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;locale_name&#39;</span><span class="p">],</span>
                                                        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
                                                        <span class="p">)[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
                         <span class="p">)</span>

<span class="c1"># Local holidays will mark every relevant record (by date and city)</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">local_holiday</span><span class="o">=</span><span class="n">data_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">holiday_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">holiday_df</span><span class="o">.</span><span class="n">locale</span> <span class="o">==</span> <span class="s1">&#39;Local&#39;</span><span class="p">],</span>
                                                     <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">],</span>
                                                     <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;locale_name&#39;</span><span class="p">],</span>
                                                     <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
                                                     <span class="p">)[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
                         <span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, we’re merging the transactions data, as well as the oil price data:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;store_nbr&#39;</span><span class="p">])</span>
<span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">oil_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Inferring-Composition">
<h2>Inferring Composition<a class="headerlink" href="#Inferring-Composition" title="Permalink to this headline">¶</a></h2>
<p>Now that the entire dataset is composed, we’ll use the attributes-related configuration we’ve set above. The complete feature set is retrieved by filtering out the <code class="docutils literal notranslate"><span class="pre">meta_attrs</span></code> from the columns list:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">all_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta_attrs</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Then, we’ll create the list of attributes for each channel of input. We’ll need such list for each combination of <em>(static/historical/futuristic)</em> and <em>(numeric/categorical)</em>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">feature_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;static_feats_numeric&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">static_attrs</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categorical_attrs</span><span class="p">],</span>
    <span class="s1">&#39;static_feats_categorical&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">static_attrs</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_attrs</span><span class="p">],</span>
    <span class="s1">&#39;historical_ts_numeric&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">static_attrs</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categorical_attrs</span><span class="p">],</span>
    <span class="s1">&#39;historical_ts_categorical&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">static_attrs</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_attrs</span><span class="p">],</span>
    <span class="s1">&#39;future_ts_numeric&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">known_attrs</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categorical_attrs</span><span class="p">],</span>
    <span class="s1">&#39;future_ts_categorical&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">known_attrs</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_attrs</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="Data-Scaling">
<h3>Data Scaling<a class="headerlink" href="#Data-Scaling" title="Permalink to this headline">¶</a></h3>
<p>We would like all of the input variables fed to the model to have similar scales. Hence, each variable will be scaled (if it is numeric) or encoded (in case it is categorical).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># allocate a dictionary to contain the scaler and encoder objects after fitting them</span>
<span class="n">scalers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;numeric&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
<span class="c1"># for the categorical variables we would like to keep the cardinalities (how many categories for each variable)</span>
<span class="n">categorical_cardinalities</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The scalers/encoders are fit according to the training set/period.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># take only the the train time range</span>
<span class="n">only_train</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">validation_bound</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p><em>Note</em>: The specific scaling method for each numeric variable was selected after examining its distribution.</p>
</div>
</div>
<div class="section" id="Fitting-the-scalers/encoders">
<h2>Fitting the scalers/encoders<a class="headerlink" href="#Fitting-the-scalers/encoders" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_attrs</span><span class="p">:</span>
        <span class="n">scalers</span><span class="p">[</span><span class="s1">&#39;categorical&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">only_train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">categorical_cardinalities</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">only_train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;log_sales&#39;</span><span class="p">]:</span>
            <span class="n">scalers</span><span class="p">[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">only_train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;day_of_month&#39;</span><span class="p">]:</span>
            <span class="n">scalers</span><span class="p">[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">only_train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scalers</span><span class="p">[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">QuantileTransformer</span><span class="p">(</span><span class="n">n_quantiles</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">only_train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Transform-by-Applying-Scalers">
<h2>Transform by Applying Scalers<a class="headerlink" href="#Transform-by-Applying-Scalers" title="Permalink to this headline">¶</a></h2>
<p>After fitting the scalers and the encoders we apply them in order to the transform the entire dataset. Note that some categories appearing in the complete dataset, might not be “familiar” to the associated label encoder. Such keys will be mapped to a new ordinal label.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_attrs</span><span class="p">:</span>
        <span class="n">le</span> <span class="o">=</span> <span class="n">scalers</span><span class="p">[</span><span class="s1">&#39;categorical&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
        <span class="c1"># handle cases with unseen keys</span>
        <span class="n">le_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span> <span class="n">le</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">classes_</span><span class="p">)))</span>
        <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">le_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">classes_</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scalers</span><span class="p">[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>After performing the transformations above, and in order to avoid null records on the target variable, we impute target signal.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;log_sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Splitting-Data">
<h3>Splitting Data<a class="headerlink" href="#Splitting-Data" title="Permalink to this headline">¶</a></h3>
<p>This stage deals with generating distinct subsets of the data for training, validation and testing the model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_sets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s1">&#39;validation&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<p>For each combination of (store,item), first we will slice the data into the training periods, as well as the validation and testing period. This primary slicing will be determined according to the argument we set in the beginning: <code class="docutils literal notranslate"><span class="pre">validation_bound</span></code>, <code class="docutils literal notranslate"><span class="pre">history_len</span></code>, and <code class="docutils literal notranslate"><span class="pre">future_len</span></code>.</p>
<p>Then we’ll slide over each slice, with offset steps dictated by <code class="docutils literal notranslate"><span class="pre">samp_interval</span></code>. for each slide (if the resulting sub-slicing results with sufficient time steps: <code class="docutils literal notranslate"><span class="pre">history_len</span> <span class="pre">+</span> <span class="pre">future_len</span></code>), we split the feature set according to the data related keys: * <code class="docutils literal notranslate"><span class="pre">static_feats_numeric</span></code> * <code class="docutils literal notranslate"><span class="pre">static_feats_categorical</span></code> * <code class="docutils literal notranslate"><span class="pre">historical_ts_numeric</span></code> * <code class="docutils literal notranslate"><span class="pre">historical_ts_categorical</span></code> * <code class="docutils literal notranslate"><span class="pre">future_ts_numeric</span></code> * <code class="docutils literal notranslate"><span class="pre">future_ts_categorical</span></code> * <code class="docutils literal notranslate"><span class="pre">target</span></code></p>
<p>where the temporal elements in this division, for each time-series, are represented as 2D arrays.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">combination_id</span><span class="p">,</span> <span class="n">combination_seq</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;combination_id&#39;</span><span class="p">)):</span>

    <span class="c1"># take the complete sequence associated with this combination and break it into the relevant periods</span>
    <span class="n">train_subset</span> <span class="o">=</span> <span class="n">combination_seq</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">combination_seq</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">validation_bound</span><span class="p">]</span>
    <span class="n">num_train_records</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_subset</span><span class="p">)</span>
    <span class="n">validation_subset_len</span> <span class="o">=</span> <span class="n">num_train_records</span> <span class="o">+</span> <span class="n">future_len</span>
    <span class="n">validation_subset</span> <span class="o">=</span> <span class="n">combination_seq</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">num_train_records</span> <span class="o">-</span> <span class="n">history_len</span><span class="p">:</span> <span class="n">validation_subset_len</span><span class="p">]</span>
    <span class="n">test_subset</span> <span class="o">=</span> <span class="n">combination_seq</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">validation_subset_len</span> <span class="o">-</span> <span class="n">history_len</span><span class="p">:]</span>

    <span class="n">subsets_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">train_subset</span><span class="p">,</span>
                    <span class="s1">&#39;validation&#39;</span><span class="p">:</span> <span class="n">validation_subset</span><span class="p">,</span>
                    <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">test_subset</span><span class="p">}</span>

    <span class="c1"># for the specific combination we&#39;re processing in the current iteration,</span>
    <span class="c1"># we&#39;d like to go over each subset separately</span>
    <span class="k">for</span> <span class="n">subset_key</span><span class="p">,</span> <span class="n">subset_data</span> <span class="ow">in</span> <span class="n">subsets_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># sliding window, according to samp_interval skips between adjacent windows</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_data</span><span class="p">),</span> <span class="n">samp_interval</span><span class="p">):</span>
            <span class="c1"># slice includes history period and horizons period</span>
            <span class="n">slc</span> <span class="o">=</span> <span class="n">subset_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">history_len</span> <span class="o">+</span> <span class="n">future_len</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">history_len</span> <span class="o">+</span> <span class="n">future_len</span><span class="p">):</span>
                <span class="c1"># skip edge cases, where not enough steps are included</span>
                <span class="k">continue</span>

            <span class="c1"># meta</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">subset_key</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;time_index&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">history_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">subset_key</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;combination_id&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combination_id</span><span class="p">)</span>

            <span class="c1"># static attributes</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">subset_key</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;static_feats_numeric&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">slc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">feature_map</span><span class="p">[</span><span class="s1">&#39;static_feats_numeric&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">subset_key</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;static_feats_categorical&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">slc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">feature_map</span><span class="p">[</span><span class="s1">&#39;static_feats_categorical&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

            <span class="c1"># historical</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">subset_key</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;historical_ts_numeric&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">slc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">history_len</span><span class="p">][</span><span class="n">feature_map</span><span class="p">[</span><span class="s1">&#39;historical_ts_numeric&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">history_len</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">subset_key</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;historical_ts_categorical&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">slc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">history_len</span><span class="p">][</span><span class="n">feature_map</span><span class="p">[</span><span class="s1">&#39;historical_ts_categorical&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">history_len</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># futuristic (known)</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">subset_key</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;future_ts_numeric&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">slc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">history_len</span><span class="p">:][</span><span class="n">feature_map</span><span class="p">[</span><span class="s1">&#39;future_ts_numeric&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">future_len</span><span class="p">,</span>
                                                                                                           <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">subset_key</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;future_ts_categorical&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">slc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">history_len</span><span class="p">:][</span><span class="n">feature_map</span><span class="p">[</span><span class="s1">&#39;future_ts_categorical&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">future_len</span><span class="p">,</span>
                                                                                                             <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># target</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">subset_key</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">slc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">history_len</span><span class="p">:][</span><span class="s1">&#39;log_sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

</pre></div>
</div>
</div>
<p>After generating the above mentioned sets, we’ll want to concatenate them into arrays for easier processing:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># for each set</span>
<span class="k">for</span> <span class="n">set_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_sets</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="c1"># for each component in the set</span>
    <span class="k">for</span> <span class="n">arr_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_sets</span><span class="p">[</span><span class="n">set_key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># list of arrays will be concatenated</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_sets</span><span class="p">[</span><span class="n">set_key</span><span class="p">][</span><span class="n">arr_key</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">set_key</span><span class="p">][</span><span class="n">arr_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data_sets</span><span class="p">[</span><span class="n">set_key</span><span class="p">][</span><span class="n">arr_key</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># lists will be transformed into arrays</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_sets</span><span class="p">[</span><span class="n">set_key</span><span class="p">][</span><span class="n">arr_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_sets</span><span class="p">[</span><span class="n">set_key</span><span class="p">][</span><span class="n">arr_key</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Export-processed-data">
<h3>Export processed data<a class="headerlink" href="#Export-processed-data" title="Permalink to this headline">¶</a></h3>
<p>Last step to perform is save this processed data to disk, together with the relevant meta data we’ll need for building the model and analyzing its outputs:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;data.pickle&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span>
        <span class="s1">&#39;data_sets&#39;</span><span class="p">:</span> <span class="n">data_sets</span><span class="p">,</span>
        <span class="s1">&#39;feature_map&#39;</span><span class="p">:</span> <span class="n">feature_map</span><span class="p">,</span>
        <span class="s1">&#39;scalers&#39;</span><span class="p">:</span> <span class="n">scalers</span><span class="p">,</span>
        <span class="s1">&#39;categorical_cardinalities&#39;</span><span class="p">:</span> <span class="n">categorical_cardinalities</span>
    <span class="p">},</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>And that’s it! We’re done with the generation of the suitable dataset.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="TrainingExample.html" class="btn btn-neutral float-right" title="Model Training" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../tutorials.html" class="btn btn-neutral float-left" title="Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Dvir Ben Or.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>